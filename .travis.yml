language: go
sudo: required
go:
  - "1.11"
services:
  - docker

env: GO111MODULE=on

install:
  - go get -u golang.org/x/lint/golint
  - go mod download
  - docker pull ipfs/go-ipfs:v0.4.18

before_script:
  - go vet ./...
  - go build ./...
  - go test -run xxxx ./...
  - make testenv

script:
  - diff -u <(echo -n) <(gofmt -d -s `find . -type f -name '*.go' -not -path "./vendor/*"`)
  - diff -u <(echo -n) <(golint `go list ./... | grep -v /vendor/`)
  - sudo -E env "PATH=$PATH" go test -race -short -coverprofile=coverage.txt ./...

after_success:
  - bash <(curl -s https://codecov.io/bash)

before_deploy:
  - make release

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: qWM4ChXOg+j5PRq3L1nxI7y6jCXQtwqnjd3HQD57hm8WxmW/Dsmx9xoOnfC+IPXJ7RLEVRwBSZscNpbHp6ttofdVhFOTuujdNfQMKYdsYD4L7TVV3b/mx6HkRdVNdl7R0BBDhVLkgCUFqK9645itW1J0K4CfmdAkmztej5G3WUYtuJ/7IaLwOsED/b3/yhiZhxVJz68cIB5h1jtBOHOTVMiJlFfgNw5aJK1YFtKSQH5P7+RExwtB5F2HbXYSVXuJgG9SrbcDGmibBtNJNPfDlztuWguMDbi3UavnTwL3uFA3t2Qu1avSHmgfUYhCj5OguqIE3OzP5UIIA/F7OorZrQjYMycfpgdPit3wKeASCN7l97BFmdzzKBW98T3LBfpYHGjuQf3OrmGzr8WEQG6GQz9Fo1t5NPiusm54LIIfRlUyHSgVs+tB2E2cxqL9+mMkJy+N4f6slgkmjziA88MRy5Qpr+/mDaFo/seSRp25m+fli/GsYsxL96GU+m0Dgn/kOtjhwdayHwgrlphzIwPaHG2cLNsvQC4ublsqR5M6KdGOkKvpc+UFzVRj9oMXXkUnxtRRFLRGGRjI2b2OICL5S0Ipc9HIiB+jAp3eybIog6AjhUTSIzxj1VbC1p7k2cDsYregR+QiCGgkd5L/3FkYiE6NuUS2DLxWvzr07S9VoB4=
  file_glob: true
  file: release/ipfs-orchestrator-*
  on:
    tags: true
    repo: RTradeLtd/ipfs-orchestrator

notifications:
  email: false
